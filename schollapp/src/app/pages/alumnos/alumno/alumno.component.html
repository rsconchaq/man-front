
<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header align-items-center d-flex">
        <h4 class="card-title mb-0 flex-grow-1">Lista de Alumnos</h4>
        <div class="flex-shrink-0">
          <button class="btn btn-success btn-sm" (click)="abrirModalNuevo()">
            Agregar Nuevo
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover w-100"
                 datatable
                 [dtOptions]="dtOptions"
                 [dtTrigger]="dtTrigger"
                 style="width: 100%;">
            <thead>
              <tr>
                <th>Código</th>
                <th>Nombres</th>
                <th>Apellidos</th>
                <th>Documento Identidad</th>
                <th>Fecha Nacimiento</th>
                <th>Sexo</th>
                <th>Ciudad</th>
                <th>Dirección</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <!-- DataTables carga los datos -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Alumno/Apoderado -->
<ng-template #alumnoModal>
  <div class="modal-header">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab==='alumno'" (click)="activeTab='alumno'">Alumno</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab==='apoderado'" (click)="activeTab='apoderado'">Apoderado</a>
      </li>
    </ul>
  </div>
  <form [formGroup]="alumnoForm" (ngSubmit)="onSubmit()">
    <div class="modal-body">
      <div [ngSwitch]="activeTab">
        <!-- Tab Alumno -->
        <div *ngSwitchCase="'alumno'">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="documentoIdentidad">Documento Identidad</label>
                <input id="documentoIdentidad" type="text" class="form-control" formControlName="documentoIdentidad" (focusout)="onDocumentoIdentidadFocusOut('ALUMNO')">
                <span class="text-danger" *ngIf="alumnoForm.get('documentoIdentidad')?.invalid && alumnoForm.get('documentoIdentidad')?.touched">
                  Documento de identidad es requerido.
                </span>
              </div>
              <div class="mb-3">
                <label for="nombres">Nombres</label>
                <input id="nombres" type="text" class="form-control" formControlName="nombres">
                <span class="text-danger" *ngIf="alumnoForm.get('nombres')?.invalid && alumnoForm.get('nombres')?.touched">
                  Nombres son requeridos.
                </span>
              </div>
              <div class="mb-3">
                <label for="fechaNacimiento">Fecha Nacimiento</label>
                <input id="fechaNacimiento" type="date" class="form-control" formControlName="fechaNacimiento" (change)="onCalcularEdad($event)">
                <span class="text-danger" *ngIf="alumnoForm.get('fechaNacimiento')?.invalid && alumnoForm.get('fechaNacimiento')?.touched">
                  Fecha de nacimiento es requerida.
                </span>
              </div>
              <div class="mb-3">
                <label for="ciudad">Ciudad</label>
                <input id="ciudad" type="text" class="form-control" formControlName="ciudad">
              </div>
              <div class="mb-3">
                <label for="diagnostico">Diagnóstico</label>
                 <select id="diagnostico" class="form-select" formControlName="diagnostico">
                  <option value="">SELECCIONE</option>
                  <option value="TEA">TEA</option>
                  <option value="TDH">TDH</option>
                  <option value="ANSIEDAD">ANSIEDAD</option>
                  <option value="DEPRESION">DEPRESION</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="codigo">Código</label>
                <input id="codigo" type="text" class="form-control" formControlName="codigo">
              </div>
              <div class="mb-3">
                <label for="apellidos">Apellidos</label>
                <input id="apellidos" type="text" class="form-control" formControlName="apellidos">
                <span class="text-danger" *ngIf="alumnoForm.get('apellidos')?.invalid && alumnoForm.get('apellidos')?.touched">
                  Apellidos son requeridos.
                </span>
              </div>
              <div class="mb-3">
                <label for="edad">Edad</label>
                <input id="edad" type="number" class="form-control" formControlName="edad">
              </div>
              <div class="mb-3">
                <label for="sexo">Sexo</label>
                <select id="sexo" class="form-select" formControlName="sexo">
                  <option value="">Seleccione</option>
                  <option value="MASCULINO">Masculino</option>
                  <option value="FEMENINO">Femenino</option>
                </select>
                <span class="text-danger" *ngIf="alumnoForm.get('sexo')?.invalid && alumnoForm.get('sexo')?.touched">
                  Sexo es requerido.
                </span>
              </div>
              <div class="mb-3">
                <label for="direccion">Dirección</label>
                <input id="direccion" type="text" class="form-control" formControlName="direccion">
              </div>
              <div class="mb-3">
                <label for="observacion">Observación</label>
                <input id="observacion" type="text" class="form-control" formControlName="observacion">
              </div>
            </div>
          </div>
        </div>
        <!-- Tab Apoderado -->
        <div *ngSwitchCase="'apoderado'">
          <div class="row">
            <div class="col-md-12">
              <div class="card mb-3">
                <div class="card-header">Principal</div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="apoderadoPrincipal_documentoIdentidad">Documento Identidad</label>
                        <input id="apoderadoPrincipal_documentoIdentidad" type="text" class="form-control" formControlName="apoderadoPrincipal_documentoIdentidad" (focusout)="onDocumentoIdentidadFocusOut('APODERADO1')">
                        <span class="text-danger" *ngIf="alumnoForm.get('apoderadoPrincipal_documentoIdentidad')?.invalid && alumnoForm.get('apoderadoPrincipal_documentoIdentidad')?.touched">
                          Documento de identidad es requerido.
                        </span>
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoPrincipal_nombres">Nombres</label>
                        <input id="apoderadoPrincipal_nombres" type="text" class="form-control" formControlName="apoderadoPrincipal_nombres">
                        <span class="text-danger" *ngIf="alumnoForm.get('apoderadoPrincipal_nombres')?.invalid && alumnoForm.get('apoderadoPrincipal_nombres')?.touched">
                          Nombres son requeridos.
                        </span>
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoPrincipal_telefono1">Teléfono 1</label>
                        <input id="apoderadoPrincipal_telefono1" type="text" class="form-control" formControlName="apoderadoPrincipal_telefono1">
                      <span class="text-danger" *ngIf="alumnoForm.get('apoderadoPrincipal_telefono1')?.invalid && alumnoForm.get('apoderadoPrincipal_telefono1')?.touched">
                          Teléfono 1 es requerido.
                      </span>
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoPrincipal_correo">Correo</label>
                        <input id="apoderadoPrincipal_correo" type="email" class="form-control" formControlName="apoderadoPrincipal_correo">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="apoderadoPrincipal_tipoRelacion">Tipo Relación</label>
                         <select id="apoderadoPrincipal_tipoRelacion" class="form-select" formControlName="apoderadoPrincipal_tipoRelacion">
                          <option value="">Seleccione</option>
                          <option value="PADRE">Padre</option>
                          <option value="MADRE">Madre</option>
                          <option value="TUTOR">Tutor</option>
                        </select>
                        <span class="text-danger" *ngIf="alumnoForm.get('apoderadoPrincipal_tipoRelacion')?.invalid && alumnoForm.get('apoderadoPrincipal_tipoRelacion')?.touched">
                          Tipo de relación es requerido.
                        </span>
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoPrincipal_apellidos">Apellidos</label>
                        <input id="apoderadoPrincipal_apellidos" type="text" class="form-control" formControlName="apoderadoPrincipal_apellidos">
                        <span class="text-danger" *ngIf="alumnoForm.get('apoderadoPrincipal_apellidos')?.invalid && alumnoForm.get('apoderadoPrincipal_apellidos')?.touched">
                          Apellidos son requeridos.
                        </span>
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoPrincipal_telefono2">Teléfono 2</label>
                        <input id="apoderadoPrincipal_telefono2" type="text" class="form-control" formControlName="apoderadoPrincipal_telefono2">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header">Secundario</div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="apoderadoSecundario_documentoIdentidad">Documento Identidad</label>
                        <input id="apoderadoSecundario_documentoIdentidad" type="text" class="form-control" formControlName="apoderadoSecundario_documentoIdentidad" (focusout)="onDocumentoIdentidadFocusOut('APODERADO2')">
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoSecundario_nombres">Nombres</label>
                        <input id="apoderadoSecundario_nombres" type="text" class="form-control" formControlName="apoderadoSecundario_nombres">
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoSecundario_telefono1">Teléfono 1</label>
                        <input id="apoderadoSecundario_telefono1" type="text" class="form-control" formControlName="apoderadoSecundario_telefono1">
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoSecundario_correo">Correo</label>
                        <input id="apoderadoSecundario_correo" type="email" class="form-control" formControlName="apoderadoSecundario_correo">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="apoderadoSecundario_tipoRelacion">Tipo Relación</label>
                         <select id="apoderadoSecundario_tipoRelacion" class="form-select" formControlName="apoderadoSecundario_tipoRelacion">
                          <option value="">Seleccione</option>
                          <option value="PADRE">Padre</option>
                          <option value="MADRE">Madre</option>
                          <option value="TUTOR">Tutor</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoSecundario_apellidos">Apellidos</label>
                        <input id="apoderadoSecundario_apellidos" type="text" class="form-control" formControlName="apoderadoSecundario_apellidos">
                      </div>
                      <div class="mb-3">
                        <label for="apoderadoSecundario_telefono2">Teléfono 2</label>
                        <input id="apoderadoSecundario_telefono2" type="text" class="form-control" formControlName="apoderadoSecundario_telefono2">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
      <button type="submit" class="btn btn-primary">Guardar</button>
    </div>
  </form>
</ng-template>


<ng-template #listaTalleresMes>
  <div class="modal-header">
    <h5 class="modal-title">Calendario de Talleres</h5>
  </div>
 
    <div class="modal-body">
      <!-- Filtros -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="ri-filter-line"></i> Filtros
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-2">
              <label class="form-label">Año:</label>
              <select class="form-select form-select-sm" [(ngModel)]="filtroAnio" (change)="aplicarFiltros()">
                <option value="">Todos</option>
                <option *ngFor="let anio of aniosDisponibles" [value]="anio">{{ anio }}</option>
              </select>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Mes:</label>
              <select class="form-select form-select-sm" [(ngModel)]="filtroMes" (change)="aplicarFiltros()">
                <option value="">Todos</option>
                <option *ngFor="let mes of mesesDisponibles" [value]="mes">{{ mes }}</option>
              </select>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Local:</label>
              <select class="form-select form-select-sm" [(ngModel)]="filtroLocal" (change)="aplicarFiltros()">
                <option value="">Todos</option>
                <option *ngFor="let local of localesDisponibles" [value]="local">{{ local }}</option>
              </select>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Día Semana:</label>
              <select class="form-select form-select-sm" [(ngModel)]="filtroDiaSemana" (change)="aplicarFiltros()">
                <option value="">Todos</option>
                <option *ngFor="let dia of diasSemanaDisponibles" [value]="dia">{{ dia }}</option>
              </select>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Etapa:</label>
              <select class="form-select form-select-sm" [(ngModel)]="filtroEtapa" (change)="aplicarFiltros()">
                <option value="">Todas</option>
                <option *ngFor="let etapa of etapasDisponibles" [value]="etapa">{{ etapa }}</option>
              </select>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Rango Edad:</label>
              <select class="form-select form-select-sm" [(ngModel)]="filtroRangoEdad" (change)="aplicarFiltros()">
                <option value="">Todos</option>
                <option *ngFor="let rango of rangoEdadDisponibles" [value]="rango">{{ rango }}</option>
              </select>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Taller:</label>
              <select class="form-select form-select-sm" [(ngModel)]="filtroTaller" (change)="aplicarFiltros()">
                <option value="">Todos</option>
                <option *ngFor="let taller of talleresDisponibles" [value]="taller">{{ taller }}</option>
              </select>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-12 text-end">
              <button class="btn btn-sm btn-secondary" (click)="limpiarFiltros()">
                <i class="ri-refresh-line"></i> Limpiar Filtros
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Resultados -->
      <div *ngIf="data.length === 0" class="alert alert-info text-center">
        <i class="ri-information-line"></i> No se encontraron talleres con los filtros seleccionados.
      </div>
      
      <div *ngFor="let mes of data" class="mb-5 calendario-talleres">
        <h4 class="text-center mb-3 fw-bold text-uppercase" style="color: #495057;">
          {{ mes.titulo }}
        </h4>
        
        <div class="table-responsive">
          <table class="table table-bordered text-center align-middle" style="min-width: 800px;">
            <thead>
              <tr>
                <th style="width: 120px; background-color: #495057; color: white;">HORARIO</th>
                <th *ngFor="let aula of obtenerTodasLasAulas(mes)" 
                    style="min-width: 200px; background-color: #495057; color: white;">
                  <i class="ri-door-line me-1"></i>{{ aula }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let horarioRow of mes.horarios">
                <!-- Columna de Horario -->
                <td [ngClass]="obtenerColorPorHorario(horarioRow.horaInicio)" 
                    class="horario-cell align-middle">
                  {{ horarioRow.horario }}
                </td>
                
                <!-- Columnas de Aulas -->
                <td *ngFor="let aulaName of obtenerTodasLasAulas(mes)" 
                    class="p-2" 
                    [class.table-light]="!obtenerTalleresDeAula(horarioRow, aulaName).length"
                    style="vertical-align: top; background-color: #f8f9fa;">
                  
                  <!-- Talleres en esta aula y horario -->
                  <div *ngFor="let taller of obtenerTalleresDeAula(horarioRow, aulaName)" 
                       class="taller-card border rounded p-2 mb-2 bg-white position-relative shadow-sm"
                       style="cursor: pointer;"
                       (click)="redireccionarMatricula(taller.idTallerApertura)">
                    
                    <!-- Header con etapa y rango de edad -->
                    <div class="mb-2 d-flex justify-content-center flex-wrap gap-1">
                      <span class="badge" style="background-color: #6366f1; font-size: 0.7rem;">
                        {{ taller.etapa }}
                      </span>
                      <span class="badge" style="background-color: #f59e0b; font-size: 0.7rem;">
                        {{ taller.rangoEdad }}
                      </span>
                    </div>

                    <!-- Nombre del taller -->
                    <div class="fw-bold text-dark mb-1 text-center" style="font-size: 0.85rem; line-height: 1.2;">
                      {{ taller.nombreLocal  }} 
                    </div>

                    <!-- Nombre del taller -->
                    <div class="fw-bold text-dark mb-1 text-center" style="font-size: 0.85rem; line-height: 1.2;">
                      {{ taller.nombreTaller  }} 
                    </div>
                    
                    <!-- Fechas -->
                    <div class="text-muted text-center small mb-1" style="font-size: 0.7rem;">
                      <i class="ri-calendar-line"></i> {{ taller.rangoFechas }}
                    </div>
                    
                    <!-- Profesor -->
                    <div class="text-secondary text-center small mb-2" style="font-size: 0.75rem;">
                      <i class="ri-user-line"></i> {{ taller.profesor }}
                    </div>
                    
                    <!-- Vacantes -->
                    <div class="d-flex justify-content-center gap-2 mt-2">
                      <div class="d-flex flex-column align-items-center">
                        <span class="badge bg-success" style="font-size: 1rem; padding: 0.4rem 0.6rem; min-width: 35px;">
                          {{ taller.matriculados }}
                        </span>
                        <small class="text-muted" style="font-size: 0.65rem;">Matriculados</small>
                      </div>
                      <div class="d-flex flex-column align-items-center">
                        <span class="badge bg-danger" style="font-size: 1rem; padding: 0.4rem 0.6rem; min-width: 35px;">
                          {{ taller.libres }}
                        </span>
                        <small class="text-muted" style="font-size: 0.65rem;">Libres</small>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Si no hay talleres, mostrar X -->
                  <div *ngIf="!obtenerTalleresDeAula(horarioRow, aulaName).length" 
                       class="aula-vacia py-4">
                    X
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>



    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="cerrarModalCronograma()">Cerrar</button>
    </div>
   
</ng-template>



<ng-template #matriculaTaller>
  <div class="modal-header">
    <button class="btn btn-secondary btn-sm" (click)="redireccionarAnterior()"><i class="las la-arrow-circle-left"></i> Anterior</button>
    <h5 class="modal-title">Detalle del taller</h5>
  </div>
  <div class="modal-body">
    <div class="card mb-3" style="background: #fff7ec;">
      <div class="card-body">
        <h6 class="mb-3" style="color: #b8860b;">Datos Academicos</h6>
        <div class="row g-2">
          <div class="col-md-2">
            <label class="form-label">Etapa</label>
            <input type="text" class="form-control form-control-sm" [value]="datosTallerSelected.descripcionEtapa || ''" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Grupo</label>
            <input type="text" class="form-control form-control-sm" [value]="datosTallerSelected.descripcionGrupo || ''" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">Descripcion Taller Academico</label>
            <input type="text" class="form-control form-control-sm" [value]="datosTallerSelected.descripcionTaller || ''" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Local</label>
            <input type="text" class="form-control form-control-sm" [value]="datosTallerSelected.descripcionLocal || ''" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Total Vacantes</label>
            <input type="text" class="form-control form-control-sm" [value]="datosTallerSelected.total_vacantes || ''" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Total Vacantes Disponibles</label>
            <input type="text" class="form-control form-control-sm" [value]="datosTallerSelected.vacantes_disponible || ''" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Fecha Inicio</label>
            <input type="text" class="form-control form-control-sm" [value]="datosTallerSelected.fechaInicio || ''" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Fecha Fin</label>
            <input type="text" class="form-control form-control-sm" [value]="datosTallerSelected.fechaFin || ''" readonly>
          </div>
        </div>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h6 class="mb-3" style="color: #1d3557;">Datos del Alumno</h6>
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Documento Identidad</label>
            <input type="text" class="form-control form-control-sm" [value]="datosAlumnoSelected.documentoIdentidad || ''" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">Nombres</label>
            <input type="text" class="form-control form-control-sm" [value]="datosAlumnoSelected.nombres || ''" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">Apellidos</label>
            <input type="text" class="form-control form-control-sm" [value]="datosAlumnoSelected.apellidos || ''" readonly>
          </div>

          <div class="col-md-3">
            <label class="form-label">Fecha Nacimiento</label>
            <input type="text" type="date" class="form-control form-control-sm" [value]="datosAlumnoSelected.fechaNacimiento || ''" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Sexo</label>
            <select class="form-control form-control-sm" [value]="datosAlumnoSelected.sexo || ''" readonly>
              <option value="MASCULINO">Masculino</option>
              <option value="FEMENINO">Femenino</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Tipo de matrícula</label>
            <select class="form-control form-control-sm" [value]="'Nuevo'">
              <option value="Nuevo">Nuevo</option>
              <option value="Antiguo">Antiguo</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-3">
      <button class="btn btn-success" (click)="registrarMatricula()">Registrar Matrícula</button>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
  </div>
</ng-template>